---
title: "Streamlined Northern Rock Sole Analyses and Figures"
author: "Laura Vary"
date: "1/23/2022"
header-includes: 
  - \usepackage{placeins}
output: 
  pdf_document: 
    toc: yes
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
setwd("C:/Users/varyl/Desktop/GitHub/BeringSeaFishes_GAM_Analyses")
library(knitr)
library(raster)
library(marmap)
library(maps)
library(mgcv)
library(colorRamps) 
library(dplyr)
library(RColorBrewer)
library(fields)
library(mapdata)
library(ggplot2)
library(ggmap)
library(ggpubr)
library(scales)
source('./Organized Thesis Analyses (Code)/distance.function.R')
source("./Organized Thesis Analyses (Code)/vis.gam_COLORS.R")
source("./Organized Thesis Analyses (Code)/euclidean.distance.R")
```

# Northern Rock Sole (NRS): 

## Loading Data: 

Northern Rock Sole: larval data only are included for this species. NRS spawn from December to March, live roughly 19 years, and transform to juveniles at standard lengths between 15 and 18 mm. 

```{r,echo=FALSE}
nrslarv.ctd<-read.csv('./Ichthyo Data/Cleaned_Cut_NrsLarv_wCTD.csv')
nrslarv.ctd<-subset(nrslarv.ctd,doy>100&doy<165)
nrslarv.ctd<-subset(nrslarv.ctd,lat<62)

str_name<-"./Environmental Data/expanded_BS_bathy.tif"
bathy<-raster(str_name)

bathybath<-as.bathy(bathy)
```

These data have been trimmed. The larval data are constrained to depths between 40 and 300 meters, to latitudes below 64.5 degrees north, and to days of year between 100 and 165. Larvae are linked to CTD-derived, $in$ $situ$ temperature and salinity measurements.

## Descriptive Information: 

```{r,echo=FALSE}
lat_range<-c(paste(round(min(nrslarv.ctd$lat),digits=1),round(max(nrslarv.ctd$lat),digits=1),sep="-"))
lon_range<-c(paste(round(min(nrslarv.ctd$lon),digits=1),round(max(nrslarv.ctd$lon),digits=1),sep=" to "))
doy_range<-c(paste(min(nrslarv.ctd$doy),max(nrslarv.ctd$doy),sep="-"))
depth_range<-c(paste(round(min(nrslarv.ctd$bottom_depth),digits=1),
                     round(max(nrslarv.ctd$bottom_depth),digits=1),sep="-"))

df<-data.frame(lat_range,lon_range,doy_range,depth_range)

kable(df,col.names=c("Lat Range","Lon Range","Day of Year Range",
                     "Bottom Depth Range"),
      caption="Descriptive Metrics for NRS Larval Data",align='c')
```

The following two plots show *the day of year distribution for positive NRS larval catch* (left) and *the year distribution for positive NRS larval catch* (right). 

```{r, fig.width=7.5,fig.height=3.5,fig.fullwidth=TRUE,fig.cap="Northern Rock Sole Larvae", echo=FALSE}
par(mfrow=c(1,2))
hist(nrslarv.ctd$doy[nrslarv.ctd$Cper10m2>0],xlab="Day of Year",ylab="Positive Catch Frequencies",main="")
hist(nrslarv.ctd$year[nrslarv.ctd$Cper10m2>0],xlab="Year",ylab="",main="")
```
\newpage
The following plots show northern rock sole larval catch distributions (Catch per unit effort, or per 10m$^2$) across five year increments from 1997 to 2016. 

```{r,echo=FALSE}
nrsylarv<-nrslarv.ctd%>%mutate(yearbin=case_when(year<=2002~'1997-2002',
                                               year<=2007&year>2002~'2003-2007',
                                               year<=2012&year>2007~'2008-2012',
                                               year<=2017&year>2012~'2013-2016'))

nrsylpos<-nrsylarv[nrsylarv$Cper10m2>0,]
nrsylpos$logcpue<-log(nrsylpos$Cper10m2+1)
nrsylz<-nrsylarv[nrsylarv$Cper10m2==0,]

bathybath<-as.bathy(bathy)
```

```{r,fig.height=10,fig.width=8,fig.align='center',fig.fullwidth=T,echo=FALSE,warning=FALSE}
autoplot.bathy(bathybath,geom=c("contour","raster"),coast=TRUE,color="grey")+
  scale_fill_gradientn("Depth (m)",values=scales::rescale(c(-7600,0,1,2321)),
                       colors=c("steelblue4","#C7E0FF","grey50","grey80"))+
  geom_point(data=nrsylz,aes(x=lon,y=lat),fill="violetred4",shape=8)+
  geom_point(data=nrsylpos,aes(x=lon,y=lat,size=logcpue),
                               fill="#993300",shape=21,alpha=0.8)+
  scale_size_continuous("Log (CPUE+1)",range=c(0,9),breaks=pretty_breaks(9))+
  theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="bottom",legend.direction="horizontal",
        legend.text=element_text(size=8))+
  scale_shape_manual(values=('No Catch'=8))+
  facet_wrap(~yearbin)+
  labs(title="Northern Rock Sole Larvae")+ylab("Latitude")+xlab("Longitude")
```

## Larval Generalized Additive Models: 

Now we'll move into the GAMs. The following code *is only necessary if the data were re-trimmed and new GAMs need to be run*. In this case, modify markdown document such that "{eval = TRUE}". The other model figures are marked as "eval = FALSE" if they, as of the last model run, do not produce the best model results. **Make sure to save the new models as RDS objects.** 

Northern rock sole larvae were best explained by the bivariate salinity-temperature model, in which the spatial and temporal distribution of larvae were modeled in association with a smooth containing *in situ* salinity-temperature data. 

We begin with the base larval model: 
```{r,eval=F,echo=FALSE}
lv.base<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
               s(bottom_depth,k=5),
             data=nrslarv.ctd,family=tw(link='log'),method='REML')

saveRDS(lv.base,"./GAM Models/nrs_larvae_base.rds")
```

```{r}
lv.base<-readRDS("./GAM Models/nrs_larvae_base.rds")
summary(lv.base)
AIC(lv.base)
```

```{r,eval=F,echo=FALSE}
lv.add.sal<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
                  s(bottom_depth,k=5)+
                  s(salinity),data=nrslarv.ctd,family=tw(link='log'),
                method='REML')

saveRDS(lv.add.sal,file="./GAM Models/nrs_larvae_addsal.rds")
```

```{r,echo=F,include=FALSE}
lv.add.sal<-readRDS("./GAM Models/nrs_larvae_addsal.rds")
summary(lv.add.sal)
```

```{r,eval=F,echo=FALSE}
lv.add.temp<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
                   s(bottom_depth,k=5)+
                   s(temperature),data=nrslarv.ctd,family=tw(link='log'),
                 method='REML')

saveRDS(lv.add.temp,file="./GAM Models/nrs_larvae_addtemp.rds")
```

```{r,include=T,echo=FALSE}
lv.add.temp<-readRDS("./GAM Models/nrs_larvae_addtemp.rds")
summary(lv.add.temp)
```

Then additive temperature and salinity, in individual additive terms. This is the second-best performing model. 
```{r,eval=F,echo=FALSE}
lv.temp.sal<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
                   s(bottom_depth,k=5)+
                   s(temperature)+s(salinity),data=nrslarv.ctd,
                 family=tw(link='log'),method='REML')

saveRDS(lv.temp.sal,file="./GAM Models/nrs_larvae_addtempsal.rds")
```

```{r}
lv.temp.sal<-readRDS("./GAM Models/nrs_larvae_addtempsal.rds")
summary(lv.temp.sal)
AIC(lv.temp.sal)
```

And finally, the best performing model: the bivariate salinity-temperature additive term: 
```{r,eval=T,echo=FALSE}
lv.2d<-gam((Cper10m2+1)~factor(year)+s(lon,lat)+s(doy,k=7)+s(bottom_depth)+
             te(salinity,temperature),data=nrslarv.ctd,family=tw(link='log'),
           method='REML')

saveRDS(lv.2d,file="./GAM Models/nrs_larvae_2d.rds")
```

```{r}
lv.2d<-readRDS("./GAM Models/nrs_larvae_2d.rds")
summary(lv.2d)
AIC(lv.2d)
```

The following plot is the predicted NRS larval biogeography based on the best performing model, the bivariate salinity-temperature GAM. Observations (log transformed, n+1) are shown as well. 
```{r,echo=FALSE}
nlat=120
nlon=120
latd=seq(min(nrslarv.ctd$lat,na.rm=TRUE),max(nrslarv.ctd$lat,na.rm=TRUE),length.out=nlat)
lond=seq(min(nrslarv.ctd$lon,na.rm=TRUE),max(nrslarv.ctd$lon,na.rm=TRUE),length.out=nlon)

grid.extent<-expand.grid(lond,latd)
names(grid.extent)<-c('lon','lat')

grid.extent$dist<-NA
for(k in 1:nrow(grid.extent)){
  dist<-distance.function(grid.extent$lat[k],grid.extent$lon[k],
                          nrslarv.ctd$lat,nrslarv.ctd$lon)
  grid.extent$dist[k]<-min(dist)
}

grid.extent$year<-as.numeric(2005)
grid.extent$doy<-as.numeric(median(nrslarv.ctd$doy,na.rm=TRUE))
grid.extent$bottom_depth<-NA
grid.extent$bottom_depth<-as.numeric(median(nrslarv.ctd$bottom_depth,na.rm=TRUE))
grid.extent$temperature<-as.numeric(mean(nrslarv.ctd$temperature))
grid.extent$salinity<-as.numeric(mean(nrslarv.ctd$salinity))
grid.extent$pred<-predict(lv.2d,newdata=grid.extent)
grid.extent$pred[grid.extent$dist>30000]<-NA 

symcol<-adjustcolor('grey',alpha=0.5)
```

```{r,fig.align='center',fig.fullwidth=TRUE,fig.width=6.5,fig.height=10,echo=FALSE}
par(mai=c(1,1,0.5,0.9),mfrow=c(2,1))
image.plot(lond,latd,t(matrix(grid.extent$pred,nrow=length(latd),
                              ncol=length(lond),byrow=T)),col=hcl.colors(100,"Lajolla"),
           ylab=expression(paste("Latitude ("^0,'N)')),xlab=expression(paste("Longitude ("^0,'E)')),
           xlim=c(-180,-155),ylim=c(52,63),
           main='Predicted NRS Larval Biogeography, 2D Model',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(bathy,levels=-c(50,200),labcex=0.4,col='grey28',add=T)
map("worldHires",fill=T,col="gainsboro",add=T)

image.plot(lond,latd,t(matrix(grid.extent$pred,nrow=length(latd),
                              ncol=length(lond),byrow=T)),col=hcl.colors(100,"Lajolla"),
           ylab=expression(paste("Latitude ("^0,'N)')),xlab=expression(paste("Longitude ("^0,'E)')),
           xlim=c(-180,-155),ylim=c(52,63),
           main='',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(bathy,levels=-c(50,200),labcex=0.4,col='grey28',add=T)
symbols(nrslarv.ctd$lon[nrslarv.ctd$Cper10m2>0],nrslarv.ctd$lat[nrslarv.ctd$Cper10m2>0],
        circles=log(nrslarv.ctd$Cper10m2+1)[nrslarv.ctd$Cper10m2>0],
        inches=0.1,bg=symcol,fg='black',add=T)
points(nrslarv.ctd$lon[nrslarv.ctd$Cper10m2>0],nrslarv.ctd$lat[nrslarv.ctd$Cper10m2>0],
       pch="+",col="white")
map("worldHires",fill=T,col="gainsboro",add=T)
```

```{r,fig.align='center',fig.fullwidth=TRUE,fig.width=6.5,fig.height=5,echo=FALSE}
par(mai=c(1,1,0.6,0.9))
plot(lv.2d,select=2,shade=T,seWithMean=TRUE,shade.col="lightgrey",
     xlab="Day of Year",ylab="Day of Year Effect")
abline(h=0,col="mistyrose4",lty=2,lwd=1.3)
```

With this bivariate model, we can also calculate the predicted anomalous larval catch (more or less than expected) on a salinity-temperature plot. This figure shows that prediction, with observed larval catch (log(n=1)) overlaid. 
```{r,echo=FALSE}
ntemp<-100
nsal<-100
tempd<-seq(min(nrslarv.ctd$temperature,na.rm=TRUE),max(nrslarv.ctd$temperature,na.rm=TRUE),length.out=ntemp)
sald<-seq(min(nrslarv.ctd$salinity,na.rm=T),max(nrslarv.ctd$salinity,na.rm=T),length.out=nsal)

grid.extent<-expand.grid(sald,tempd)
names(grid.extent)<-c('salinity','temperature')

grid.extent$dist<-NA
for(k in 1:nrow(grid.extent)){
  dist<-euclidean.distance(grid.extent$salinity[k],grid.extent$temperature[k],
                               nrslarv.ctd$salinity,nrslarv.ctd$temperature)
  grid.extent$dist[k]<-min(dist)
}

grid.extent$year<-as.numeric(2005)
grid.extent$lon<-as.numeric(median(nrslarv.ctd$lon))
grid.extent$lat<-as.numeric(median(nrslarv.ctd$lat))
grid.extent$doy<-as.numeric(median(nrslarv.ctd$doy,na.rm=TRUE))
grid.extent$bottom_depth<-NA
grid.extent$bottom_depth<-as.numeric(median(nrslarv.ctd$bottom_depth,na.rm=TRUE))
grid.extent$pred<-predict(lv.2d,newdata=grid.extent)
grid.extent$pred[grid.extent$dist>mean(grid.extent$dist)]<-NA #threshold based on means
```

```{r,echo=FALSE,fig.align='center',fig.width=6.5,fig.height=10,fig.fullwidth=TRUE}
par(mai=c(1,1,0.5,0.9),mfrow=c(2,1))
image.plot(sald,tempd,t(matrix(grid.extent$pred,nrow=length(tempd),ncol=length(sald),byrow=T)),
           col=hcl.colors(100,"Lajolla"),xlab='Salinity (psu)',
           ylab=expression(paste("Temperature ("^0, 'C)')),
           xlim=range(nrslarv.ctd$salinity,na.rm=T),ylim=range(nrslarv.ctd$temperature,na.rm=T),
           main='',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(sald,tempd,t(matrix(grid.extent$pred,nrow=length(tempd),ncol=length(sald),byrow=T)),
        col="white",level=c(3.2,4.2),add=T) #mean and 3rd quantile 

image.plot(sald,tempd,t(matrix(grid.extent$pred,nrow=length(tempd),ncol=length(sald),byrow=T)),
           col=hcl.colors(100,"Lajolla"),xlab='Salinity (psu)',
           ylab=expression(paste("Temperature ("^0, 'C)')),
           xlim=range(nrslarv.ctd$salinity,na.rm=T),ylim=range(nrslarv.ctd$temperature,na.rm=T),
           main='NRS Larval Biogeography By Temperature and Salinity',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
symbols(nrslarv.ctd$salinity[nrslarv.ctd$Cper10m2>0],
        nrslarv.ctd$temperature[nrslarv.ctd$Cper10m2>0],
        circles=log(nrslarv.ctd$Cper10m2+1)[nrslarv.ctd$Cper10m2>0],
        inches=0.1,bg=symcol,fg='black',add=T)
points(nrslarv.ctd$salinity[nrslarv.ctd$Cper10m2==0],
        nrslarv.ctd$temperature[nrslarv.ctd$Cper10m2==0],pch="+",col="white")
```

Now I'll calculate a specific range of temperature, salinity, and both temperature and salinity to evaluate breadth of environmental tolerances. 

For the univariate predictions, make a grid that holds either temperature or salinity constant depending on the variable of interest. 

```{r,echo=FALSE}
ntemp<-100
tempd<-seq(min(nrslarv.ctd$temperature,na.rm=TRUE),max(nrslarv.ctd$temperature,na.rm=TRUE),length.out=ntemp)

unit<-data.frame(matrix(ncol=1,nrow=100))
names(unit)<-'temperature'
unit$temperature<-as.numeric(tempd)

for(k in 1:nrow(unit)){
  unit$dist[k]<-unit$temperature[k]-nrslarv.ctd$temperature[k]
}

unit$year<-as.numeric(2005)
unit$lon<-as.numeric(median(nrslarv.ctd$lon))
unit$lat<-as.numeric(median(nrslarv.ctd$lat))
unit$doy<-as.numeric(median(nrslarv.ctd$doy,na.rm=TRUE))
unit$bottom_depth<-as.numeric(median(nrslarv.ctd$bottom_depth,na.rm=TRUE))
unit$salinity<-as.numeric(median(nrslarv.ctd$salinity,na.rm=T))
unit$pred<-predict(lv.2d,newdata=unit)
unit$pred[unit$dist>mean(unit$dist)]<-NA

nsal<-100
sald<-seq(min(nrslarv.ctd$salinity,na.rm=T),max(nrslarv.ctd$salinity,na.rm=T),length.out=nsal)
unis<-data.frame(matrix(ncol=1,nrow=100))
names(unis)<-'salinity'
unis$salinity<-as.numeric(sald)

for(k in 1:nrow(unis)){
  unis$dist[k]<-unis$salinity[k]-nrslarv.ctd$salinity[k]
}

unis$year<-as.numeric(2005)
unis$lon<-as.numeric(median(nrslarv.ctd$lon))
unis$lat<-as.numeric(median(nrslarv.ctd$lat))
unis$doy<-as.numeric(median(nrslarv.ctd$doy,na.rm=TRUE))
unis$bottom_depth<-as.numeric(median(nrslarv.ctd$bottom_depth,na.rm=TRUE))
unis$temperature<-as.numeric(median(nrslarv.ctd$temperature,na.rm=T))
unis$pred<-predict(lv.2d,newdata=unis)
unis$pred[unis$dist>mean(unis$dist)]<-NA

unit<-unit[!is.na(unit$pred),]
unis<-unis[!is.na(unis$pred),]

clipt<-as.numeric(0.6*dim(unit)[[1]])
clips<-as.numeric(0.6*dim(unit)[[1]])

grid.sort.t<-unit%>%arrange(desc(pred))
grid.sort.s<-unis%>%arrange(desc(pred))

grid.clip.t<-grid.sort.t%>%slice_head(n=clipt)
grid.clip.s<-grid.sort.s%>%slice_head(n=clips)
```


```{r,echo=FALSE,fig.align='center',fig.width=8,fig.height=6,fig.fullwidth=TRUE,warning=FALSE}
temp<-ggplot(grid.clip.t,aes(x=temperature,y=pred))+geom_point(color='grey')+geom_smooth(method="loess")+
  theme_bw()+theme(axis.text.x=element_text(angle=45,hjust=1))+
  labs(x='Temperature',y='Prediction')+
  scale_x_continuous(breaks=round(seq(min(grid.clip.t$temperature),max(grid.clip.t$temperature),by=0.75),1))

sal<-ggplot(grid.clip.s,aes(x=salinity,y=pred))+geom_point(color='grey')+geom_smooth(method="loess")+
  theme_bw()+labs(x='Salinity',y='Prediction')+
  scale_x_continuous(breaks=round(seq(min(grid.clip.s$salinity),max(grid.clip.s$salinity),by=0.4),1))

par(mai=c(1,1,0.5,0.9))
ggarrange(temp,sal)
```

For the bivariate analysis: 
```{r,echo=FALSE}
grid.extent<-grid.extent[!is.na(grid.extent$pred),] #remove NAs to get proper percentage of predictions, use grid extent previously calculated 

clip<-as.numeric(0.6*dim(grid.extent)[[1]]) #define nrows = to 60% of prediction grid 

grid.sort<-grid.extent%>%arrange(desc(pred))

grid.clip<-grid.sort%>%slice_head(n=clip) #clip top 70% of prediction grid 
head(grid.clip)

#write.csv(grid.clip,'Ak_larv_clip_60.csv')
```

```{r,echo=FALSE,fig.align='center',fig.width=6,fig.height=6,fig.fullwidth=TRUE}
par(mai=c(1,1,0.5,0.9))
bivar<-ggplot(grid.clip)+geom_tile(aes(x=salinity,y=temperature,fill=pred))+theme_bw()+
  labs(x='Salinity',y='Temperature')+scale_fill_viridis()
bivar
```

To again share the improvements of the best performing models from the base models, we can look at the AIC division produces. 
```{r,echo=FALSE}
bestdiv<-c(AIC(lv.2d)/AIC(lv.base))
second<-c(AIC(lv.2d)/AIC(lv.temp.sal))
stage<-"Larvae"

df<-data.frame(stage,bestdiv,second)
kable(df,col.names=c("","Best Divided By Base","Best Divided By Second Best"),
      caption="Model Power through AIC Comparisons, Northern Rock Sole",align='c')
```


Reduction in MSE (%):  
```{r,echo=FALSE}
var.ratio.lv<-(summary(lv.base)$scale-summary(lv.2d)$scale)/summary(lv.base)$scale
perc<-var.ratio.lv*100
print(perc)
```

