---
title: "Streamlined Flathead Sole Analyses & Figures"
author: "Laura Vary"
date: "1/23/2022"
header-includes: 
  - \usepackage{placeins}
output: 
  pdf_document: 
    toc: yes
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
setwd("C:/Users/varyl/Desktop/GitHub/BeringSeaFishes_GAM_Analyses")
library(knitr)
library(raster)
library(marmap)
library(maps)
library(mgcv)
library(colorRamps) 
library(RColorBrewer)
library(dplyr)
library(fields)
library(mapdata)
library(ggplot2)
library(ggmap)
library(ggpubr)
library(scales)
library(mapdata)
source('./Organized Thesis Analyses (Code)/distance.function.R')
source("./Organized Thesis Analyses (Code)/vis.gam_COLORS.R")
source("./Organized Thesis Analyses (Code)/euclidean.distance.R")
```

# Flathead Sole: 

## Loading Data: 

Flathead sole: both egg and larval data are included for this species. Flathead sole spawn from February to July, live roughly 21 years, and transform to juveniles at standard lengths between 18 to 21 mm. 

```{r,echo=FALSE}
fhsub<-read.csv(file='./Ichthyo Data/Cleaned_Cut_FhEggs.csv',header=TRUE,
                check.names=TRUE)
fhlarv.ctd<-read.csv(file='./Ichthyo Data/Cleaned_Cut_FhLarv_wCTD.csv',
                     header=TRUE,check.names=TRUE)
fhlarv.ctd<-subset(fhlarv.ctd,doy>99)

reg.sst<-read.csv('./Environmental Data/Mar_SST_RegionalIndex_NCEP_BS.csv',
                  header=TRUE,check.names=TRUE)

str_name<-"./Environmental Data/expanded_BS_bathy.tif"
bathy<-raster(str_name)
```

These data have been trimmed. The egg data are constrained to depths between 54 and 221 meters; temporally, the egg data are constrained to above the 99th day of year and below the 283rd day of the year (temporally centered on the spawning period of flathead sole). The egg data are also joined to regional temperature indices for each year (the reg.sst dataset). The larval data are also constrained to depths between 54 and 221 m, above the 100th day of the year. Larvae are linked to CTD-derived, $in$ $situ$ temperature and salinity measurements. Both eggs and larvae are restricted to latitudes below 61 degrees north. 

The regional temperature index data are constrained to (-180, -151) degrees W and (50.5, 67.5) degrees N and reflect the average March temperature for each year across that region. March temperatures are chosen to estimate the conditions spawning flathead sole may have experienced, roughly two months before the peak amount of eggs in the water column occurs.  

## Descriptive Information: 

```{r,echo=FALSE}
lat_range<-c(paste(round(min(fhsub$lat),digits=1),round(max(fhsub$lat),digits=1),sep="-"))
lon_range<-c(paste(round(min(fhsub$lon),digits=1),round(max(fhsub$lon),digits=1),sep=" to "))
doy_range<-c(paste(min(fhsub$doy),max(fhsub$doy),sep="-"))
depth_range<-c(paste(round(min(fhsub$bottom_depth),digits=1),
                     round(max(fhsub$bottom_depth),digits=1),sep="-"))

df<-data.frame(lat_range,lon_range,doy_range,depth_range)

kable(df,col.names=c("Lat Range","Lon Range","Day of Year Range",
                     "Bottom Depth Range"),
      caption="Descriptive Metrics for Flathead Sole Egg Data",align='c')
```
```{r,echo=FALSE}
lat_range<-c(paste(round(min(fhlarv.ctd$lat),digits=1),round(max(fhlarv.ctd$lat),digits=1),sep="-"))
lon_range<-c(paste(round(min(fhlarv.ctd$lon),digits=1),round(max(fhlarv.ctd$lon),digits=1),sep=" to "))
doy_range<-c(paste(min(fhlarv.ctd$doy),max(fhlarv.ctd$doy),sep="-"))
depth_range<-c(paste(round(min(fhlarv.ctd$bottom_depth),digits=1),
                     round(max(fhlarv.ctd$bottom_depth),digits=1),sep="-"))

df<-data.frame(lat_range,lon_range,doy_range,depth_range)

kable(df,col.names=c("Lat Range","Lon Range","Day of Year Range",
                     "Bottom Depth Range"),
      caption="Descriptive Metrics for Flathead Sole Larval Data",align='c')
```

The following two plots show *the day of year distribution for positive Flathead sole egg catch* (left) and *the year distribution for positive Flathead sole egg catch* (right). Analogous plots for larval data are following. 

```{r, fig.width=7.5,fig.height=3,fig.fullwidth=TRUE,fig.cap="Flathead Sole Eggs", echo=FALSE}
par(mfrow=c(1,2))
hist(fhsub$doy[fhsub$Cper10m2>0],xlab="Day of Year",ylab="Positive Catch Frequencies",main="")
hist(fhsub$year[fhsub$Cper10m2>0],xlab="Year",ylab="",main="")
```

```{r, fig.width=7.5,fig.height=3,fig.fullwidth=TRUE,fig.cap="Flathead Sole Larvae", echo=FALSE}
par(mfrow=c(1,2))
hist(fhlarv.ctd$doy[fhlarv.ctd$Cper10m2>0],xlab="Day of Year",ylab="Positive Catch Frequencies",main="")
hist(fhlarv.ctd$year[fhlarv.ctd$Cper10m2>0],xlab="Year",ylab="Positive Catch Frequencies",main="")
```
The following plots show flathead sole egg and larval catch distributions (Catch per unit effort, or per 10m$^2$) across five year increments from 1979 to 2016. 
```{r,echo=FALSE,eval=F}
fhysub<-fhsub%>%mutate(yearbin=case_when(year<=1984~'1979-1984',
                                         year<=1989&year>1984~'1985-1989',
                                         year<=1994&year>1989~'1990-1994',
                                         year<=1999&year>1994~'1995-1999',
                                         year<=2004&year>1999~'2000-2004',
                                         year<=2009&year>2004~'2005-2009',
                                         year<=2014&year>2009~'2010-2014',
                                         year<=2019&year>2014~'2015-2016'))
fhypos<-fhysub[fhysub$Cper10m2>0,]
fhyz<-fhysub[fhysub$Cper10m2==0,]
fhypos$logcpue<-log(fhypos$Cper10m2+1)

bathybath<-as.bathy(bathy)
```

```{r,fig.height=10,fig.width=8,fig.align='center',fig.fullwidth=T,echo=FALSE,warning=FALSE,eval=F}
autoplot.bathy(bathybath,geom=c("contour","raster"),coast=TRUE,color="grey")+
  scale_fill_gradientn("Depth (m)",values=scales::rescale(c(-7600,0,1,2321)),
                       colors=c("steelblue4","#C7E0FF","grey50","grey80"))+
  geom_point(data=fhyz,aes(x=lon,y=lat),fill="violetred4",shape=8)+
  geom_point(data=fhypos,aes(x=lon,y=lat,size=logcpue),
                        fill="#993300",shape=21,alpha=0.8)+
  scale_size_continuous("Log (CPUE + 1)",range=c(0,9),breaks=pretty_breaks(9))+
  theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="bottom",legend.direction="horizontal",
        legend.text=element_text(size=8))+
  facet_wrap(~yearbin)+
  labs(title="Flathead Sole Eggs",shape="Log (CPUE + 1)")+ylab("Latitude")+xlab("Longitude")
```

```{r,echo=FALSE,eval=F}
fhylarv<-fhlarv.ctd%>%mutate(yearbin=case_when(year<=2002~'1997-2002',
                                               year<=2007&year>2002~'2003-2007',
                                               year<=2012&year>2007~'2008-2012',
                                               year<=2017&year>2012~'2013-2016'))

fhylpos<-fhylarv[fhylarv$Cper10m2>0,]
fhylpos$logcpue<-log(fhylpos$Cper10m2+1)
fhylz<-fhylarv[fhylarv$Cper10m2==0,]
```


```{r,fig.height=10,fig.width=8,fig.align='center',fig.fullwidth=T,echo=FALSE,warning=FALSE,eval=F}
autoplot.bathy(bathybath,geom=c("contour","raster"),coast=TRUE,color="grey")+
  scale_fill_gradientn("Depth (m)",values=scales::rescale(c(-7600,0,1,2321)),
                       colors=c("steelblue4","#C7E0FF","grey50","grey80"))+
  geom_point(data=fhylz,aes(x=lon,y=lat),fill="violetred4",shape=8)+
  geom_point(data=fhylpos,aes(x=lon,y=lat,size=logcpue),
                               fill="#993300",shape=21,alpha=0.8)+
  scale_size_continuous("Log (CPUE+1)",range=c(0,9),breaks=pretty_breaks(9))+
  theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="bottom",legend.direction="horizontal",
        legend.text=element_text(size=8))+
  scale_shape_manual(values=('No Catch'=8))+
  facet_wrap(~yearbin)+
  labs(title="Flathead Sole Larvae")+ylab("Latitude")+xlab("Longitude")
```

Now we'll move into the GAMs. The following code *is only necessary if the data were re-trimmed and new GAMs need to be run*. In this case, modify markdown document such that "{eval = TRUE}". The other model figures are marked as "eval = FALSE" if they, as of the last model run, do not produce the best model results. **Make sure to save the new models as RDS objects.** 

Flathead sole eggs were best explained by the threshold phenology model, in which the temporal distribution of eggs varied differently below and above 2.29 degrees Celsius. 

## Generalized Additive Models: Flathead Sole Eggs

The base model formulation: 
```{r, eval=T,echo=FALSE}
eg.base<-gam((Cper10m2+1)~factor(year)+s(lon,lat)+s(doy)+s(bottom_depth,k=5),
             data=fhsub,family=tw(link='log'),method='REML')

summary(eg.base)
AIC(eg.base)
```

```{r, eval=T,echo=FALSE}
plot(eg.base,shade=FALSE,page=1,seWithMean=TRUE,scheme=2,scale=0)

saveRDS(eg.base,file="./GAM Models/fh_egg_base.rds")
```

```{r,eval=F}
eg.base<-readRDS("./GAM Models/fh_egg_base.rds")
summary(eg.base)
AIC(eg.base)
```

```{r, eval=T,echo=FALSE}
vc.geo<-gam((Cper10m2+1)~factor(year)+s(lon,lat)+s(doy)+s(bottom_depth,k=5)+
              s(lon,lat,by=reg.SST),data=fhsub,family=tw(link='log'),
            method='REML')

summary(vc.geo)
AIC(vc.geo)
```

```{r, eval=T,echo=FALSE}
par(mfrow=c(1,2))
plot(vc.geo,select=1,scheme=2,too.far=0.025,shade=FALSE,
     seWithMean=TRUE,xlab='Longitude',ylab='Latitude',
     main='V-C FH Egg Flex Geo, Avg. Variation')
map("world",fill=T,col="snow4",add=T)
plot(vc.geo,select=4,scheme=2,too.far=0.025,shade=FALSE,
     xlab='Longitude',ylab='Latitude',seWithMean=TRUE,
     main='V-C Flex Geo, Deviation from Avg. Variation')
map("world",fill=T,col="snow4",add=T)

saveRDS(vc.geo,file="./GAM Models/fh_egg_vc_geo.rds")
```

```{r,echo=FALSE,include=FALSE,eval=F}
vc.geo<-readRDS("./GAM Models/fh_egg_vc_geo.rds")
summary(vc.geo)
```

The variable-coefficient phenology formulation (in which temporal (phenological) distribution of eggs vary in relation to regional SST indices). This was the second-best performing model for flathead sole egg variation. 
```{r, eval=T,echo=FALSE}
vc.pheno<-gam((Cper10m2+1)~factor(year)+s(lon,lat)+s(doy)+s(bottom_depth,k=5)+
                s(doy,by=reg.SST),data=fhsub,family=tw(link='log'),
              method='REML')

summary(vc.pheno)
AIC(vc.pheno)
```

```{r, eval=T,echo=FALSE}
par(oma=c(1,1,1,0.5),mar=c(3,3,3,1.5))
plot(vc.pheno,select=2,main='Flathead Sole VC Phenology, Eggs',seWithMean=TRUE,
     ylim=c(-25,11))
abline(h=0,col='mistyrose4',lty=2,lwd=1.3)
par(oma=c(1,1,1,0.5),mar=c(3,3,3,1.5),new=TRUE)
plot(vc.pheno,select=4,seWithMean=TRUE,shade=TRUE,shade.col="skyblue",ylim=c(-25,11))
legend('topright',legend=c('Flexible Phenology Smooth','Deviation from Avg.Phenology'),
       col=c(NA,"skyblue"),lwd=c(2,2),cex=0.8)
mtext(c("Day of Year","Anomalies in log(CPUE+1)"),side=c(1,2),line=2.5)

saveRDS(vc.pheno,file="./GAM Models/fh_egg_vc_pheno.rds")
```

```{r,eval=F}
vc.pheno<-readRDS("./GAM Models/fh_egg_vc_pheno.rds")
summary(vc.pheno)
AIC(vc.pheno)
```

```{r,echo=FALSE,eval=T}
aic.geo<-NA*(temps.in)
thr.geo<-as.list(1:(length(temps.in)))

for(i in 1:length(temps.in)){
  fhsub$th<-factor(fhsub$reg.SST<=temps.in[i])
  thr.geo[[i]]<-gam((Cper10m2+1)~factor(year)+s(doy)+s(bottom_depth,k=5)+
                      s(lon,lat,by=th),data=fhsub,
                    family=tw(link='log'),method='REML')
  aic.geo[i]<-AIC(thr.geo[[i]])
}

best.index.geo<-order(aic.geo)[1]
thr.geo<-thr.geo[[best.index.geo]]
```

```{r,eval=T,echo=FALSE}
saveRDS(aic.geo,file="./GAM Models/fh_egg_aic_geo_list.rds")
saveRDS(thr.geo,file="./GAM Models/fh_egg_thr_geo.rds")
saveRDS(best.index.geo,file="./GAM Models/fh_egg_best_index_geo.rds")
```
```{r,echo=FALSE,eval=F}
thr.geo<-readRDS("./GAM Models/fh_egg_thr_geo.rds")
best.index.geo<-readRDS("./GAM Models/fh_egg_best_index_geo.rds")
#aic.geo<-readRDS("./GAM Models/fh_egg_aic_geo_list.rds")
```
```{r,eval=T,echo=FALSE}
summary(thr.geo)
AIC(thr.geo)
```

The threshold phenology model formulation (in which the temporal (phenological) distribution of eggs vary differently above and below a threshold temperature. 
*This is the best model to explain Flathead sole egg variation across years, as of 1/10/2021*. 
```{r,echo=FALSE}
temps<-sort(unique(reg.sst$SST))
bd<-4
temps.in<-temps[bd:(length(temps)-bd)]
```

```{r,eval=T}
aic.pheno<-NA*(temps.in)
thr.pheno<-as.list(1:(length(temps.in)))

for(i in 1:length(temps.in)){
  fhsub$th<-factor(fhsub$reg.SST<=temps.in[i])
  thr.pheno[[i]]<-gam((Cper10m2+1)~factor(year)+
                        s(lon,lat)+
                        s(bottom_depth,k=5)+
                        s(doy,by=th),
                      data=fhsub,family=tw(link='log'),method='REML')
  aic.pheno[i]<-AIC(thr.pheno[[i]])
}

best.index.phe<-order(aic.pheno)[1]
thr.pheno<-thr.pheno[[best.index.phe]]
```


```{r, eval=T, echo=FALSE}
saveRDS(aic.pheno,file="./GAM Models/fh_egg_aic_pheno_list.rds")
saveRDS(thr.pheno,file="./GAM Models/fh_egg_thr_pheno.rds")
saveRDS(temps.in,file="./GAM Models/fh_egg_temps_in_pheno.rds")
saveRDS(best.index.phe,file="./GAM Models/fh_egg_best_index_phe.rds")
```

```{r,echo=FALSE,eval=F}
temps.in<-readRDS("./GAM Models/fh_egg_temps_in_pheno.rds") #same for geo and pheno models 
aic.pheno<-readRDS("./GAM Models/fh_egg_aic_pheno_list.rds") 
thr.pheno<-readRDS("./GAM Models/fh_egg_thr_pheno.rds")
best.index.phe<-readRDS("./GAM Models/fh_egg_best_index_phe.rds")
```

```{r}
summary(thr.pheno)
AIC(thr.pheno)
temp<-temps.in[[best.index.phe]]

print(temps.in[[best.index.phe]])
```

```{r, fig.width=6,fig.height=4,fig.fullwidth=TRUE,echo=FALSE,eval=FALSE}
par(oma=c(1,1,1,0.5),mar=c(3,3,3,1.5))
plot(thr.pheno,select=4,main='Flathead Sole Phenology, Eggs',seWithMean=TRUE,
     ylim=c(-4.2,2))
abline(h=0,col='mistyrose4',lty=2,lwd=1.3)
par(oma=c(1,1,1,0.5),mar=c(3,3,3,1.5),new=TRUE)
plot(thr.pheno,select=3,seWithMean=TRUE,shade=TRUE,shade.col=col,ylim=c(-4.2,2))
legend('topright',legend=c('Below','Above'),col=c(NA,col),lwd=c(2,2),cex=0.8)
mtext(c("Day of Year","Day of Year Effect"),side=c(1,2),line=2.5)
```

To confirm that the threshold phenology model is indeed the best model, we can compare AIC values across all five tested models. 
```{r, echo=FALSE}
aic.base<-AIC(eg.base)
aic.thrph<-AIC(thr.pheno)
aic.thrge<-AIC(thr.geo)
aic.vcph<-AIC(vc.pheno)
aic.vcgeo<-AIC(vc.geo)

aic.fhegg<-data.frame('model'=c('Base','Threshold Pheno','Threshold Geo',
                                'VC Pheno','VC Geo'),
                      'AIC_value'=c(aic.base,aic.thrph,aic.thrge,
                                    aic.vcph,aic.vcgeo))
```

```{r,fig.fullwidth=TRUE,fig.width=6.5,fig.height=4.5,fig.align='center',echo=FALSE}
plot(c(1:5),aic.fhegg$AIC_value,main='FHS',
     col=hcl.colors(5,"Zissou 1"),
     pch=19,cex=2,ylab='AIC Score',xlab='')
grid(nx=5,ny=14,col="lightgray")
text(c(1:5),aic.fhegg$AIC_value,labels=round(aic.fhegg$AIC_value),pos=c(4,3,3,2,2))
legend("topright",legend=c('Base','Thr. Phenology','Thr. Geography',
                             'V-C Phenology','V-C Geography'),
       col=hcl.colors(5,"Zissou 1"),
       lwd=3,lty=1,cex=0.6)
```

```{r, fig.width=7.5,fig.height=4,fig.fullwidth=TRUE,fig.align='center', echo=FALSE, eval=FALSE}
par(mfrow=c(1,2))
plot(thr.geo,select=4,scheme=2,too.far=0.025,
     main='Below Threshold',sep=" "),
     shade=FALSE,seWithMean=TRUE,xlab='Longitude',ylab='Latitude')
map("world",fill=T,col="gainsboro",add=T)
plot(thr.geo,select=3,scheme=2,too.far=0.025,
     main='Above Threshold',sep=" "),
     shade=FALSE,seWithMean=TRUE,xlab='Longitude',ylab='Latitude')
map("world",fill=T,col="gainsboro",add=T)
```

This is the below threshold and above threshold temporal distribution of flathead eggs (based on the threshold phenology model). 
```{r,fig.fullwidth=TRUE,fig.align='center',echo=FALSE,fig.width=6,fig.height=4}
col<-adjustcolor('tomato4',alpha.f=0.25)

par(oma=c(1,1,0.25,0.5),mar=c(3,3,3,1.5))
plot(thr.pheno,select=4,main='',seWithMean=TRUE,
     ylim=c(-3,3))
abline(h=0,col='mistyrose4',lty=2,lwd=1.3)
par(oma=c(1,1,0.25,0.5),mar=c(3,3,3,1.5),new=TRUE)
plot(thr.pheno,select=3,seWithMean=TRUE,shade=TRUE,shade.col=col,ylim=c(-3,3))
legend('topright',legend=c(expression(paste('Below 2.31' ^0,'C')),
                           expression(paste('Above 2.31' ^0,'C'))),
                           lwd=c(1.3,1.5),lty=c(5,1),
       col=c('grey13',col),cex=0.8)
mtext(c("Day of Year","Day of Year Effect"),side=c(1,2),line=2.5)
```

```{r, fig.width=6.5,fig.height=4,fig.fullwidth=TRUE,fig.cap='Thr. Pheno AIC scores across varying threshold temperatures, Flathead Sole.',echo=FALSE}
plot(temps.in,aic.pheno,type='b',lwd=2,ylim=range(c(AIC(eg.base),aic.pheno)),
     main='',ylab='AIC Score',
     xlab=expression(paste('Temperature (' ^0,'C)')))
abline(h=AIC(eg.base),lty=2,lwd=2,col='sienna3')
abline(v=temps.in[best.index.phe],lty=2,lwd=2,col='steelblue3')
legend("bottomleft",cex=0.8,lty=c(2,2),lwd=c(1.2,1.2),col=c('sienna3',
                                                            'steelblue3'),
       legend=c("Base Model","Best Model"))
```

With the threshold phenology model, we can model the spatial distribution of flathead sole eggs through predictions based on this model. Observed, log-transformed (n+1) egg catches are displayed as well. 
```{r,echo=FALSE}
nlat=120
nlon=120
latd=seq(min(fhsub$lat),max(fhsub$lat),length.out=nlat) #center grid over study region 
lond=seq(min(fhsub$lon),max(fhsub$lon),length.out=nlon)

grid.extent<-expand.grid(lond,latd)
names(grid.extent)<-c('lon','lat')

#calculate distance to each positive observation
grid.extent$dist<-NA
for(k in 1:nrow(grid.extent)){
  dist<-distance.function(grid.extent$lat[k],grid.extent$lon[k],
                          fhsub$lat,fhsub$lon)
  grid.extent$dist[k]<-min(dist)
}

grid.extent$year<-as.numeric(2013) #for base, just pick a year that has coverage
grid.extent$doy<-as.numeric(median(fhsub$doy,na.rm=TRUE))
grid.extent$bottom_depth<-NA
grid.extent$bottom_depth<-median(fhsub$bottom_depth,na.rm=TRUE)
grid.extent$reg.SST<-NA
grid.extent$reg.SST<-mean(fhsub$reg.SST,na.rm=TRUE) 
grid.extent$th<-as.character("TRUE")
grid.extent$pred<-predict(thr.pheno,newdata=grid.extent)
grid.extent$pred[grid.extent$dist>30000]<-NA 

symcol<-adjustcolor("grey28",alpha=0.5)
```

```{r,fig.align='center',fig.width=6.5,fig.height=10,fig.fullwidth=TRUE,echo=FALSE}
par(mai=c(1,1,0.5,0.9),mfrow=c(2,1))
image.plot(lond,latd,t(matrix(grid.extent$pred,nrow=length(latd),
                              ncol=length(lond),byrow=T)),col=hcl.colors(100,"Lajolla"),
           ylab=expression(paste("Latitude ("^0,'N)')),xlab=expression(paste("Longitude ("^0,'E)')),
           xlim=c(-180,-155),ylim=c(52,63),main='',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(bathy,levels=-c(50,200),labcex=0.4,col='grey28',add=T)
map("worldHires",fill=T,col="gainsboro",add=T)

image.plot(lond,latd,t(matrix(grid.extent$pred,nrow=length(latd),
                              ncol=length(lond),byrow=T)),col=hcl.colors(100,"Lajolla"),
           ylab=expression(paste("Latitude ("^0,'N)')),xlab=expression(paste("Longitude ("^0,'E)')),
           xlim=c(-180,-155),ylim=c(52,63),main='Flathead Sole Distribution, Th.Ph, Eggs',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(bathy,levels=-c(50,200),labcex=0.4,col='grey28',add=T)
points(fhsub$lon[fhsub$Cper10m2==0],fhsub$lat[fhsub$Cper10m2==0],pch='+',col='white')
symbols(fhsub$lon[fhsub$Cper10m2>0],
        fhsub$lat[fhsub$Cper10m2>0],
        circles=log(fhsub$Cper10m2+1)[fhsub$Cper10m2>0],
        inches=0.1,bg=symcol,fg='black',add=T)
map("worldHires",fill=T,col="gainsboro",add=T)
```

Reduction in MSE (%):  
```{r,echo=FALSE}
var.ratio.geo<-(summary(eg.base)$scale-summary(thr.geo)$scale)/summary(eg.base)$scale
perc<-var.ratio.geo*100
print(perc)
```


## Larval Generalized Additive Models: 
The following code *is only necessary if the data were re-trimmed and new GAMs need to be run*. In this case, modify markdown document such that "{eval = TRUE}". The other model figures are marked as "eval = FALSE" if they, as of the last model run, 
do not produce the best model results. These models are produced using conductivity-temperature-depth derived temperature and salinity measurements. 

We begin with the base larval model: 
```{r,eval=F,echo=FALSE}
lv.base<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
               s(bottom_depth,k=5),
             data=fhlarv.ctd,family=tw(link='log'),method='REML')

saveRDS(lv.base,file="./GAM Models/fh_larv_base.rds")
```

```{r,include=FALSE}
lv.base<-readRDS("./GAM Models/fh_larv_base.rds")
summary(lv.base)
AIC(lv.base)
```

```{r,eval=F,echo=FALSE}
lv.add.sal<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
                  s(bottom_depth,k=5)+
                  s(salinity),data=fhlarv.ctd,family=tw(link='log'),
                method='REML')

saveRDS(lv.add.sal,file="./GAM Models/fh_larv_addsal.rds")
```

```{r,echo=F,include=FALSE}
lv.add.sal<-readRDS("./GAM Models/fh_larv_addsal.rds")
summary(lv.add.sal)
AIC(lv.add.sal)
```

```{r,eval=F,echo=FALSE}
lv.add.temp<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
                   s(bottom_depth,k=5)+
                   s(temperature),data=fhlarv.ctd,family=tw(link='log'),
                 method='REML')

saveRDS(lv.add.temp,file="./GAM Models/fh_larv_addtemp.rds")
```

```{r,include=FALSE,echo=FALSE}
lv.add.temp<-readRDS("./GAM Models/fh_larv_addtemp.rds")
summary(lv.add.temp)
AIC(lv.add.temp)
```

Then additive temperature and salinity, in individual additive terms. This is the second-best performing model. 
```{r,eval=F,echo=FALSE}
lv.temp.sal<-gam((Cper10m2+1)~factor(year)+s(doy,k=7)+s(lon,lat)+
                   s(bottom_depth,k=5)+
                   s(temperature)+s(salinity),data=fhlarv.ctd,
                 family=tw(link='log'),method='REML')

saveRDS(lv.temp.sal,file="./GAM Models/fh_larv_tempsal.rds")
```

```{r,include=FALSE}
lv.temp.sal<-readRDS("./GAM Models/fh_larv_tempsal.rds")
summary(lv.temp.sal)
AIC(lv.temp.sal)
```

And finally, the best performing model: the bivariate salinity-temperature additive term: 
```{r,eval=F,echo=FALSE}
lv.2d<-gam((Cper10m2+1)~factor(year)+s(lon,lat)+s(doy,k=7)+s(bottom_depth)+
             te(salinity,temperature),data=fhlarv.ctd,family=tw(link='log'),
           method='REML')

saveRDS(lv.2d,file="./GAM Models/fh_larv_2d.rds")
```

```{r}
lv.2d<-readRDS("./GAM Models/fh_larv_2d.rds")
summary(lv.2d)
AIC(lv.2d)
```
To confirm that this is indeed the best model, we can compare AIC values across all five tested models. 
```{r, echo=FALSE}
aic.base<-AIC(lv.base)
aic.sal<-AIC(lv.add.sal)
aic.temp<-AIC(lv.add.temp)
aic.saltemp<-AIC(lv.temp.sal)
aic.2d<-AIC(lv.2d)

aic.fhlarv<-data.frame('model'=c('Base','Add Sal','Add Temp',
                                'Sal and Temp','2-d Sal-Temp'),
                      'AIC_value'=c(aic.base,aic.sal,aic.temp,
                                    aic.saltemp,aic.2d))
```



```{r,echo=FALSE}
windows(width=6,height=5);par(mai=c(1,1,0.5,0.9))
plot(c(1:5),aic.fhlarv$AIC_value,main='FH',
     col=hcl.colors(5,"Zissou 1"),
     pch=19,cex=2,ylab='AIC Score',xlab='')
grid(nx=5,ny=14,col="lightgray")
text(c(1:5),aic.fhlarv$AIC_value,labels=round(aic.fhlarv$AIC_value),pos=c(4,1,3,2,2))
legend("bottomleft",legend=c('Base','Add. SSS','Add. SST',
                             'Add. SSS, SST','Bivariate SSS-SST'),
       col=hcl.colors(5,"Zissou 1"),
       lwd=3,lty=1,cex=0.7)
```



The following plot is the predicted Flathead sole larval biogeography based on the best performing model, the bivariate salinity-temperature GAM. Observations (log transformed, n+1) are shown as well. 
```{r,echo=FALSE}
nlat=120
nlon=120
latd=seq(min(fhlarv.ctd$lat,na.rm=TRUE),max(fhlarv.ctd$lat,na.rm=TRUE),length.out=nlat)
lond=seq(min(fhlarv.ctd$lon,na.rm=TRUE),max(fhlarv.ctd$lon,na.rm=TRUE),length.out=nlon)

grid.extent<-expand.grid(lond,latd)
names(grid.extent)<-c('lon','lat')

grid.extent$dist<-NA
for(k in 1:nrow(grid.extent)){
  dist<-distance.function(grid.extent$lat[k],grid.extent$lon[k],
                          fhlarv.ctd$lat,fhlarv.ctd$lon)
  grid.extent$dist[k]<-min(dist)
}

grid.extent$year<-as.numeric(2016)
grid.extent$doy<-as.numeric(median(fhlarv.ctd$doy,na.rm=TRUE))
grid.extent$bottom_depth<-NA
grid.extent$bottom_depth<-as.numeric(median(fhlarv.ctd$bottom_depth,na.rm=TRUE))
grid.extent$temperature<-as.numeric(mean(fhlarv.ctd$temperature))
grid.extent$salinity<-as.numeric(mean(fhlarv.ctd$salinity))
grid.extent$pred<-predict(lv.2d,newdata=grid.extent)
grid.extent$pred[grid.extent$dist>30000]<-NA 
```

```{r,fig.align='center',fig.fullwidth=TRUE,fig.wdith=5,fig.height=10,echo=FALSE}
par(mai=c(1,1,0.5,0.9),mfrow=c(2,1))
image.plot(lond,latd,t(matrix(grid.extent$pred,nrow=length(latd),
                              ncol=length(lond),byrow=T)),col=hcl.colors(100,"Lajolla"),
           ylab=expression(paste("Latitude ("^0,'N)')),xlab=expression(paste("Longitude ("^0,'E)')),
           xlim=c(-180,-155),ylim=c(52,63),
           main='',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(bathy,levels=-c(50,200),labcex=0.4,col='grey28',add=T)
map("worldHires",fill=T,col="gainsboro",add=T)

image.plot(lond,latd,t(matrix(grid.extent$pred,nrow=length(latd),
                              ncol=length(lond),byrow=T)),col=hcl.colors(100,"Lajolla"),
           ylab=expression(paste("Latitude ("^0,'N)')),xlab=expression(paste("Longitude ("^0,'E)')),
           xlim=c(-180,-155),ylim=c(52,63),
           main='',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(bathy,levels=-c(50,200),labcex=0.4,col='grey28',add=T)
symbols(fhlarv.ctd$lon[fhlarv.ctd$Cper10m2>0],
        fhlarv.ctd$lat[fhlarv.ctd$Cper10m2>0],
        circles=log(fhlarv.ctd$Cper10m2+1)[fhlarv.ctd$Cper10m2>0],
        inches=0.1,bg=symcol,fg='black',add=T)
points(fhlarv.ctd$lon[fhlarv.ctd$Cper10m2==0],
        fhlarv.ctd$lat[fhlarv.ctd$Cper10m2==0],pch="+",col="white")
map("worldHires",fill=T,col="gainsboro",add=T)
```

```{r,fig.align='center',fig.fullwidth=TRUE,fig.width=6.5,fig.height=5,echo=FALSE}
par(mai=c(1,1,0.6,0.9))
plot(lv.2d,select=2,shade=T,seWithMean=TRUE,shade.col="lightgrey",
     xlab="Day of Year",ylab="Day of Year Effect")
abline(h=0,col="mistyrose4",lty=2,lwd=1.3)
```

With this bivariate model, we can also calculate the predicted anomalous larval catch (more or less than expected) on a salinity-temperature plot. This figure shows that prediction, with observed larval catch (log(n=1)) overlaid. 
```{r,echo=FALSE}
ntemp<-100
nsal<-100
tempd<-seq(min(fhlarv.ctd$temperature,na.rm=TRUE),max(fhlarv.ctd$temperature,na.rm=TRUE),length.out=ntemp)
sald<-seq(min(fhlarv.ctd$salinity,na.rm=T),max(fhlarv.ctd$salinity,na.rm=T),length.out=nsal)

grid.extent<-expand.grid(sald,tempd)
names(grid.extent)<-c('salinity','temperature')

grid.extent$dist<-NA
for(k in 1:nrow(grid.extent)){
  dist<-euclidean.distance(grid.extent$salinity[k],grid.extent$temperature[k],
                               fhlarv.ctd$salinity,fhlarv.ctd$temperature)
  grid.extent$dist[k]<-min(dist)
}

grid.extent$year<-as.numeric(2005)
grid.extent$lon<-as.numeric(median(fhlarv.ctd$lon))
grid.extent$lat<-as.numeric(median(fhlarv.ctd$lat))
grid.extent$doy<-as.numeric(median(fhlarv.ctd$doy,na.rm=TRUE))
grid.extent$bottom_depth<-NA
grid.extent$bottom_depth<-as.numeric(median(fhlarv.ctd$bottom_depth,na.rm=TRUE))
grid.extent$pred<-predict(lv.2d,newdata=grid.extent)
grid.extent$pred[grid.extent$dist>mean(grid.extent$dist)]<-NA #threshold based on means
```

```{r,echo=FALSE,fig.align='center',fig.width=6.5,fig.height=10,fig.fullwidth=TRUE}
par(mai=c(1,1,0.5,0.9), mfrow=c(2,1))
image.plot(sald,tempd,t(matrix(grid.extent$pred,nrow=length(tempd),ncol=length(sald),byrow=T)),
           col=hcl.colors(100,"Lajolla"),xlab='Salinity (psu)',
           ylab=expression(paste("Temperature ("^0, 'C)')),
           xlim=c(29,33.5),ylim=c(-1.8,14),
           main='',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
contour(sald,tempd,t(matrix(grid.extent$pred,nrow=length(tempd),ncol=length(sald),byrow=T)),
        col="white",levels=c(3.5,4.3),add=T)

image.plot(sald,tempd,t(matrix(grid.extent$pred,nrow=length(tempd),ncol=length(sald),byrow=T)),
           col=hcl.colors(100,"Lajolla"),xlab='Salinity (psu)',
           ylab=expression(paste("Temperature ("^0, 'C)')),
           xlim=c(29,33.5),ylim=c(-1.8,14),
           main='Larval Biogeography By Temperature and Salinity',
           cex.main=1,cex.lab=1,cex.axis=0.9,legend.line=-2,
           legend.lab=expression(paste("Anomalies in (log(C/(10m"^2,')+1)')),legend.shrink=0.3)
symbols(fhlarv.ctd$salinity[fhlarv.ctd$Cper10m2>0],
        fhlarv.ctd$temperature[fhlarv.ctd$Cper10m2>0],
        circles=log(fhlarv.ctd$Cper10m2+1)[fhlarv.ctd$Cper10m2>0],
        inches=0.1,bg=symcol,fg='black',add=T)
points(fhlarv.ctd$salinity[fhlarv.ctd$Cper10m2==0],
        fhlarv.ctd$temperature[fhlarv.ctd$Cper10m2==0],pch="+",col="white")
```

Now I'll calculate a specific range of temperature, salinity, and both temperature and salinity to evaluate breadth of environmental tolerances. 

For the univariate predictions, make a grid that holds either temperature or salinity constant depending on the variable of interest. The temperature and salinity values held constant were chosen based on the bivariate temperature,salinity plots; I attempted to capture a representative snapshot of variability in the univariate dimension. 

First, I'll determine the sum of larval log(CPUE+1) predictions and 60% of that sum, to know how many rows to cut from the larger extent. 

```{r,echo=FALSE}
sum<-sum(grid.extent$pred,na.rm=T)
sum

clip60<-0.6*sum
clip60 #determine 60% of summed CPUE predictions 

grid.extent1<-grid.extent
grid.extent1$pos<-seq.int(nrow(grid.extent1))
grid.extent1<-grid.extent1%>%arrange(pred)
grid.extent1$consum<-cumsum(grid.extent1$pred)
grid.extent1<-grid.extent1[grid.extent1$consum>clip60,]

grid.clip<-grid.extent1%>%arrange(grid.extent1$pos)

#write.csv(grid.clip,'Fh_larv_clip_60.csv')
```

So this percentage (percbi, 42.7%) is the percentage of the total grid extent within which 60% of the predicted log(CPUE+1) lies. I.e., 42.7% percent of the whole grid extent encompasses 60% of the predicted observations. 

```{r,echo=FALSE}
ntemp<-100
tempd<-seq(min(fhlarv.ctd$temperature,na.rm=TRUE),max(fhlarv.ctd$temperature,na.rm=TRUE),length.out=ntemp)

unit<-data.frame(matrix(ncol=1,nrow=100))
names(unit)<-'temperature'
unit$temperature<-as.numeric(tempd)

for(k in 1:nrow(unit)){
  unit$dist[k]<-unit$temperature[k]-fhlarv.ctd$temperature[k]
}

unit$year<-as.numeric(2005)
unit$lon<-as.numeric(median(fhlarv.ctd$lon))
unit$lat<-as.numeric(median(fhlarv.ctd$lat))
unit$doy<-as.numeric(median(fhlarv.ctd$doy,na.rm=TRUE))
unit$bottom_depth<-as.numeric(median(fhlarv.ctd$bottom_depth,na.rm=TRUE))
unit$salinity<-31.75 #near the peak predictions 
unit$pred<-predict(lv.2d,newdata=unit)
unit$salinity<-31.5
unit$pred.1<-predict(lv.2d,newdata=unit)
unit$salinity<-31.25
unit$pred.2<-predict(lv.2d,newdata=unit)
unit$salinity<-32
unit$pred.3<-predict(lv.2d,newdata=unit)
unit$salinity<-32.25
unit$pred.4<-predict(lv.2d,newdata=unit)
unit$salinity<-31
unit$pred.5<-predict(lv.2d,newdata=unit)
unit$pred[unit$dist>mean(unit$dist)]<-NA
unit$pred.1[unit$dist>mean(unit$dist)]<-NA
unit$pred.2[unit$dist>mean(unit$dist)]<-NA
unit$pred.3[unit$dist>mean(unit$dist)]<-NA
unit$pred.4[unit$dist>mean(unit$dist)]<-NA
unit$pred.5[unit$dist>mean(unit$dist)]<-NA


nsal<-100
sald<-seq(min(fhlarv.ctd$salinity,na.rm=T),max(fhlarv.ctd$salinity,na.rm=T),length.out=nsal)
unis<-data.frame(matrix(ncol=1,nrow=100))
names(unis)<-'salinity'
unis$salinity<-as.numeric(sald)

for(k in 1:nrow(unis)){
  unis$dist[k]<-unis$salinity[k]-fhlarv.ctd$salinity[k]
}

unis$year<-as.numeric(2005)
unis$lon<-as.numeric(median(fhlarv.ctd$lon))
unis$lat<-as.numeric(median(fhlarv.ctd$lat))
unis$doy<-as.numeric(median(fhlarv.ctd$doy,na.rm=TRUE))
unis$bottom_depth<-as.numeric(median(fhlarv.ctd$bottom_depth,na.rm=TRUE))
unis$temperature<-10.3 #centralized in peak predictions
unis$pred<-predict(lv.2d,newdata=unis)
unis$temperature<-10.6
unis$pred.1<-predict(lv.2d,newdata=unis)
unis$temperature<-11
unis$pred.2<-predict(lv.2d,newdata=unis)
unis$temperature<-13
unis$pred.3<-predict(lv.2d,newdata=unis)
unis$temperature<-9.5
unis$pred.4<-predict(lv.2d,newdata=unis)
unis$temperature<-8
unis$pred.5<-predict(lv.2d,newdata=unis)
unis$pred[unis$dist>mean(unis$dist)]<-NA
unis$pred.1[unis$dist>mean(unis$dist)]<-NA
unis$pred.2[unis$dist>mean(unis$dist)]<-NA
unis$pred.3[unis$dist>mean(unis$dist)]<-NA
unis$pred.4[unis$dist>mean(unis$dist)]<-NA
unis$pred.5[unis$dist>mean(unis$dist)]<-NA


unit<-unit[!is.na(unit$pred),]
unis<-unis[!is.na(unis$pred),]

clipt60<-0.6*(sum(unit$pred,na.rm=T))
clips60<-0.6*(sum(unis$pred,na.rm=T))

grid.t1<-unit
grid.t1$pos<-seq.int(nrow(grid.t1))
grid.t1<-grid.t1%>%arrange(pred)
grid.t1$consum<-cumsum(grid.t1$pred)
grid.t1<-grid.t1[grid.t1$consum>clipt60,]
grid.clip.t<-grid.t1%>%arrange(grid.t1$pos)

grid.s1<-unis
grid.s1$pos<-seq.int(nrow(grid.s1))
grid.s1<-grid.s1%>%arrange(pred)
grid.s1$consum<-cumsum(grid.s1$pred)
grid.s1<-grid.s1[grid.s1$consum>clips60,]
grid.clip.s<-grid.s1%>%arrange(grid.s1$pos)

```


```{r,echo=FALSE,fig.align='center',fig.width=8,fig.height=6,fig.fullwidth=TRUE,warning=FALSE}
temp<-ggplot(grid.clip.t,aes(x=temperature,y=pred))+geom_point(color='grey')+geom_smooth(method="loess")+
  geom_line(aes(x=temperature,y=pred.1),linetype="solid",color="grey48")+
  geom_line(aes(x=temperature,y=pred.2),linetype="twodash",color="grey48")+
  geom_line(aes(x=temperature,y=pred.3),linetype="longdash",color="grey48")+
  geom_line(aes(x=temperature,y=pred.4),linetype="dotted",color="grey48")+
  geom_line(aes(x=temperature,y=pred.5),linetype="dotdash",color="grey48")+
  theme_bw()+theme(axis.text.x=element_text(angle=45,hjust=1,size=7.5))+
  labs(x=expression(paste("Temperature ("^0,'C)')),y='Prediction')+
  scale_x_continuous(breaks=seq(-1.7,14,by=1),limits=c(-1.7,14))+
  scale_y_continuous(breaks=seq(1,7.3,by=1),limits=c(1,7.3))

sal<-ggplot(grid.clip.s,aes(x=salinity,y=pred))+geom_point(color='grey')+geom_smooth(method="loess")+
  geom_line(aes(x=salinity,y=pred.1),linetype="solid",color="grey48")+
  geom_line(aes(x=salinity,y=pred.2),linetype="twodash",color="grey48")+
  geom_line(aes(x=salinity,y=pred.3),linetype="longdash",color="grey48")+
  geom_line(aes(x=salinity,y=pred.4),linetype="dotted",color="grey48")+
  geom_line(aes(x=salinity,y=pred.5),linetype="dotdash",color="grey48")+
  theme_bw()+labs(x='Salinity (psu)',y='Prediction')+
  theme(axis.text.x=element_text(hjust=1,angle=45,size=7.5))+
  scale_x_continuous(breaks=round(seq(29,33.3,by=0.5),1),limits=c(29,33.3))+
  scale_y_continuous(breaks=seq(1,7.3,by=1),limits=c(1,7.3))

par(mai=c(1,1,0.5,0.9))
ggarrange(temp,sal)
```

For the bivariate analysis: 

```{r,echo=FALSE,fig.align='center',fig.width=6,fig.height=6,fig.fullwidth=TRUE}
par(mai=c(1,1,0.5,0.9))
bivar<-ggplot(grid.clip)+geom_tile(aes(x=salinity,y=temperature,fill=pred))+theme_bw()+
  theme(axis.text.x=element_text(angle=45,hjust=1,size=7.5))+
  geom_vline(xintercept=31.75,linetype="dashed",color="black")+
  geom_hline(yintercept=10.3,linetype="dashed",color="black")+
  geom_vline(xintercept=31.5,linetype="solid",color="grey48")+
  geom_vline(xintercept=31.25,linetype="twodash",color="grey48")+
  geom_vline(xintercept=32,linetype="longdash",color="grey48")+
  geom_vline(xintercept=32.5,linetype="dotted",color="grey48")+
  geom_vline(xintercept=31,linetype="dotdash",color="grey48")+
  geom_hline(yintercept=10.6,linetype="solid",color="grey48")+
  geom_hline(yintercept=11,linetype="twodash",color="grey48")+
  geom_hline(yintercept=13,linetype="longdash",color="grey48")+
  geom_hline(yintercept=9.5,linetype="dotted",color="grey48")+
  geom_hline(yintercept=8,linetype="dotdash",color="grey48")+
  labs(x='Salinity (psu)',y=expression(paste("Temperature ("^0,'C)')))+scale_fill_viridis(name='Prediction')+
  scale_x_continuous(breaks=seq(29,33.3,by=0.5),limits=c(29,33.3))+
  scale_y_continuous(breaks=seq(-1.7,14,by=1),limits=c(-1.7,14))
bivar
```

Determine area in T-S units over which 60% of observations are contained. 

```{r,echo=FALSE}
width<-max(grid.extent$salinity)-min(grid.extent$salinity)
height<-max(grid.extent$temperature)-min(grid.extent$temperature)
area.all<-width*height

width.cl<-max(grid.clip$salinity)-min(grid.clip$salinity)
height.cl<-max(grid.clip$temperature)-min(grid.clip$temperature)
area.clip<-width.cl*height.cl

perc.area<-(area.clip/area.all)*100
perc.area
```

62.7% of the salinity-temperature area contains 60% of the total predicted log(CPUE+1). 

To again share the improvements of the best performing models from the base models, we can look at the AIC division produces. 
```{r,echo=FALSE}
bestdiv<-c((AIC(thr.geo)/AIC(eg.base)),(AIC(lv.2d)/AIC(lv.base)))
second<-c((AIC(thr.geo)/AIC(vc.geo)),(AIC(lv.2d)/AIC(lv.temp.sal)))
stage<-c("Eggs","Larvae")

df<-data.frame(stage,bestdiv,second)
kable(df,col.names=c("","Best Divided By Base","Best Divided By Second Best"),
      caption="Model Power through AIC Comparisons, Flathead Sole",align='c')
```


Reduction in MSE (%):  
```{r,echo=FALSE}
var.ratio.lv<-(summary(lv.base)$scale-summary(lv.2d)$scale)/summary(lv.base)$scale
perc<-var.ratio.lv*100
print(perc)
```

## Appendices: 

The following plots investigate the diverging phenological peaks in egg density below and above the threshold temperature in order to evaluate whether different peaks correlate to different spatial areas in the BS. 

```{r,echo=FALSE}
fhd1<-fhsub[fhsub$Cper10m2>0&fhsub$doy>164&fhsub$doy<196&fhsub$reg.SST<temps.in[[best.index.phe]],]
fhd1$logcpue<-log(fhd1$Cper10m2+1)
fhdz1<-fhsub[fhsub$Cper10m2==0&fhsub$doy>164&fhsub$doy<196&fhsub$reg.SST<temps.in[[best.index.phe]],]

fhd2<-fhsub[fhsub$Cper10m2>0&fhsub$doy>144&fhsub$doy<156&fhsub$reg.SST>temps.in[[best.index.phe]],]
fhd2$logcpue<-log(fhd2$Cper10m2+1)
fhdz2<-fhsub[fhsub$Cper10m2==0&fhsub$doy>144&fhsub$doy<156&fhsub$reg.SST>temps.in[[best.index.phe]],]

fhd3<-fhsub[fhsub$Cper10m2>0&fhsub$doy>189&fhsub$doy<206&fhsub$reg.SST>temps.in[[best.index.phe]],]
fhd3$logcpue<-log(fhd3$Cper10m2+1)
fhdz3<-fhsub[fhsub$Cper10m2==0&fhsub$doy>189&fhsub$doy<206&fhsub$reg.SST>temps.in[[best.index.phe]],]
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
set1<-autoplot.bathy(bathybath,geom=c("contour","raster"),coast=TRUE,color="grey")+
  scale_fill_gradientn("Depth (m)",values=scales::rescale(c(-7600,0,1,2321)),
                       colors=c("steelblue4","#C7E0FF","grey50","grey80"))+
  geom_point(data=fhdz1,aes(x=lon,y=lat),fill="violetred4",shape=8)+
  geom_point(data=fhd1,aes(x=lon,y=lat,size=logcpue),
                        fill="#993300",shape=21,alpha=0.8)+
  scale_size_continuous(expression(paste("log(C/(10m"^2,')+1)')),range=c(0,9),
                        breaks=pretty_breaks(9))+
  theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="bottom",legend.direction="horizontal",
        legend.text=element_text(size=8))+
  labs(title="Below Threshold; DOY 165-195",
       shape=expression(paste("log(C/(10m"^2,')+1)')))+
  ylab(expression(paste("Latitude ("^o,')')))+xlab(expression(paste("Longitude ("^o,'E)')))

set2<-autoplot.bathy(bathybath,geom=c("contour","raster"),coast=TRUE,color="grey")+
  scale_fill_gradientn("Depth (m)",values=scales::rescale(c(-7600,0,1,2321)),
                       colors=c("steelblue4","#C7E0FF","grey50","grey80"))+
  geom_point(data=fhdz2,aes(x=lon,y=lat),fill="violetred4",shape=8)+
  geom_point(data=fhd2,aes(x=lon,y=lat,size=logcpue),
                        fill="#993300",shape=21,alpha=0.8)+
  scale_size_continuous(expression(paste("log(C/(10m"^2,')+1)')),range=c(0,9),breaks=pretty_breaks(9))+
  theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="bottom",legend.direction="horizontal",
        legend.text=element_text(size=8))+
  labs(title="Above Threshold; DOY 145-155",
       shape=expression(paste("log(C/(10m"^2,')+1)')))+
  ylab(expression(paste("Latitude ("^o,')')))+xlab(expression(paste("Longitude ("^o,'E)')))

set3<-autoplot.bathy(bathybath,geom=c("contour","raster"),coast=TRUE,color="grey")+
  scale_fill_gradientn("Depth (m)",values=scales::rescale(c(-7600,0,1,2321)),
                       colors=c("steelblue4","#C7E0FF","grey50","grey80"))+
  geom_point(data=fhdz3,aes(x=lon,y=lat),fill="violetred4",shape=8)+
  geom_point(data=fhd3,aes(x=lon,y=lat,size=logcpue),
                        fill="#993300",shape=21,alpha=0.8)+
  scale_size_continuous(expression(paste("log(C/(10m"^2,')+1)')),range=c(0,9),breaks=pretty_breaks(9))+
  theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="bottom",legend.direction="horizontal",
        legend.text=element_text(size=8))+
  labs(title="Above Threshold; DOY 190-205",
       shape=expression(paste("log(C/(10m"^2,')+1)')))+
  ylab(expression(paste("Latitude ("^o,')')))+xlab(expression(paste("Longitude ("^o,'E)')))
```

```{r,fig.fullwidth=T,fig.align='center',fig.width=8,fig.height=10,echo=F}
ggarrange(set1,set2,set3,common.legend=T,legend="bottom")
```

